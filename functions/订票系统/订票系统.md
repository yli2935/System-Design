# è®¢ç¥¨/ç§’æ€ç³»ç»Ÿè®¾è®¡ - ç¥¨åŠ¡é¢„ç•™æœºåˆ¶

## ç›®å½•

- [é—®é¢˜èƒŒæ™¯](#é—®é¢˜èƒŒæ™¯)
- [æ ¸å¿ƒéœ€æ±‚](#æ ¸å¿ƒéœ€æ±‚)
- [è§£å†³æ–¹æ¡ˆå¯¹æ¯”](#è§£å†³æ–¹æ¡ˆå¯¹æ¯”)
  - [æ–¹æ¡ˆä¸€ï¼šé•¿æ—¶é—´æ•°æ®åº“é”ï¼ˆä¸æ¨èï¼‰](#æ–¹æ¡ˆä¸€é•¿æ—¶é—´æ•°æ®åº“é”ä¸æ¨è)
  - [æ–¹æ¡ˆäºŒï¼šçŠ¶æ€å­—æ®µ + è¿‡æœŸæ—¶é—´ + å®šæ—¶ä»»åŠ¡](#æ–¹æ¡ˆäºŒçŠ¶æ€å­—æ®µ--è¿‡æœŸæ—¶é—´--å®šæ—¶ä»»åŠ¡)
  - [æ–¹æ¡ˆä¸‰ï¼šåŒå±æ€§æ£€æŸ¥ + çŸ­äº‹åŠ¡ï¼ˆæ¨èï¼‰](#æ–¹æ¡ˆä¸‰åŒå±æ€§æ£€æŸ¥--çŸ­äº‹åŠ¡æ¨è)
  - [æ–¹æ¡ˆå››ï¼šRedis åˆ†å¸ƒå¼é”ï¼ˆé«˜å¹¶å‘æ¨èï¼‰](#æ–¹æ¡ˆå››redis-åˆ†å¸ƒå¼é”é«˜å¹¶å‘æ¨è)
- [æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“](#æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“)
- [æœ€ä½³å®è·µå»ºè®®](#æœ€ä½³å®è·µå»ºè®®)

---

## é—®é¢˜èƒŒæ™¯

### ç”¨æˆ·ç—›ç‚¹

åœ¨ä¼ ç»Ÿçš„è®¢ç¥¨ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·ä½“éªŒå­˜åœ¨ä¸¥é‡é—®é¢˜ï¼š

- **æ—¶é—´æµªè´¹**ï¼šç”¨æˆ·èŠ±è´¹ 5 åˆ†é’Ÿå¡«å†™æ”¯ä»˜è¡¨æ ¼
- **é¢„æœŸè½ç©º**ï¼šæäº¤æ—¶å‘ç°ç¥¨å·²è¢«ä»–äººæŠ¢è´­
- **æŒ«è´¥æ„Ÿå¼º**ï¼šæ— æ³•ä¿è¯å¡«è¡¨è¿‡ç¨‹ä¸­çš„ç¥¨åŠ¡æ‰€æœ‰æƒ

### ä¸šåŠ¡åœºæ™¯

è¿™ä¸ªé—®é¢˜æ™®éå­˜åœ¨äºé«˜å¹¶å‘åœºæ™¯ä¸­ï¼š

- âœˆï¸ æœºç¥¨é¢„è®¢
- ğŸ« æ¼”å”±ä¼š/æ´»åŠ¨é—¨ç¥¨
- ğŸ¨ é…’åº—æˆ¿é—´é¢„è®¢
- âš¡ ç§’æ€å•†å“æŠ¢è´­
- ğŸ® æ¸¸æˆè£…å¤‡ç«æ‹

### å¸¸è§è§£å†³æ–¹æ¡ˆ

ä¸šç•Œå¸¸è§åšæ³•æ˜¯åœ¨ç”¨æˆ·ç»“è´¦æ—¶æ˜¾ç¤º**å€’è®¡æ—¶å™¨**ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…ï¼ˆå¦‚ 5-10 åˆ†é’Ÿï¼‰ä¸ºç”¨æˆ·é¢„ç•™ç¥¨åŠ¡ã€‚

---

## æ ¸å¿ƒéœ€æ±‚

è®¾è®¡ç¥¨åŠ¡é¢„ç•™ç³»ç»Ÿéœ€è¦æ»¡è¶³ä»¥ä¸‹æ ¸å¿ƒè¦æ±‚ï¼š

| éœ€æ±‚       | æè¿°                                 |
| ---------- | ------------------------------------ |
| **ç‹¬å æ€§** | ç”¨æˆ·ç»“è´¦æœŸé—´ï¼Œå…¶ä»–äººæ— æ³•è´­ä¹°åŒä¸€å¼ ç¥¨ |
| **æ—¶æ•ˆæ€§** | å¦‚æœç”¨æˆ·æ”¾å¼ƒè´­ä¹°ï¼Œç¥¨åŠ¡åº”è‡ªåŠ¨é‡Šæ”¾     |
| **ç¡®å®šæ€§** | å®Œæˆæ”¯ä»˜åï¼Œç¥¨åŠ¡çŠ¶æ€åº”ç«‹å³ç¡®è®¤       |
| **é«˜æ€§èƒ½** | èƒ½å¤Ÿå¤„ç†é«˜å¹¶å‘åœºæ™¯ï¼ˆç§’æ€ï¼‰           |
| **å¯é æ€§** | é¿å…æ­»é”ã€èµ„æºè€—å°½ç­‰é—®é¢˜             |

---

## è§£å†³æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆä¸€ï¼šé•¿æ—¶é—´æ•°æ®åº“è¡Œé”ï¼ˆä¸æ¨èï¼‰

#### å®ç°åŸç†

ä½¿ç”¨æ•°æ®åº“çš„**äº¤äº’å¼äº‹åŠ¡**å’Œ**è¡Œçº§é”**æ¥ä¿è¯ç‹¬å æ€§ã€‚

#### æŠ€æœ¯å®ç°

```sql
-- PostgreSQL ç¤ºä¾‹
BEGIN;

-- é”å®šç‰¹å®šç¥¨åŠ¡è¡Œï¼Œå…¶ä»–äº‹åŠ¡ä¼šè¢«é˜»å¡
SELECT * FROM tickets
WHERE ticket_id = 12345
FOR UPDATE;

-- ç”¨æˆ·å¡«å†™è¡¨å•ï¼ˆ5åˆ†é’Ÿï¼‰...

-- å®Œæˆè´­ä¹°
UPDATE tickets
SET status = 'BOOKED', user_id = 67890
WHERE ticket_id = 12345;

COMMIT; -- é‡Šæ”¾é”
```

#### é”é‡Šæ”¾æœºåˆ¶

**åœºæ™¯ä¸€ï¼šç”¨æˆ·å®Œæˆè´­ä¹°**

```
äº‹åŠ¡ COMMIT â†’ é”é‡Šæ”¾ â†’ çŠ¶æ€æ›´æ–°ä¸º "BOOKED"
```

**åœºæ™¯äºŒï¼šç”¨æˆ·æ”¾å¼ƒè´­ä¹°**

```
ä¾èµ–ï¼š
- ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆæ“ä½œï¼ˆROLLBACKï¼‰
- ä¼šè¯è¶…æ—¶æœºåˆ¶
- åº”ç”¨å±‚è¶…æ—¶æ§åˆ¶
```

#### âŒ ä¸»è¦é—®é¢˜

##### 1. **èµ„æºè€—å°½é—®é¢˜**

**é—®é¢˜æè¿°ï¼š** é•¿æ—¶é—´æŒæœ‰æ•°æ®åº“è¿æ¥å’Œé”ä¼šå¿«é€Ÿè€—å°½ç³»ç»Ÿèµ„æº

**å…·ä½“åœºæ™¯ï¼š**

```
æ•°æ®åº“è¿æ¥æ± é…ç½®ï¼š
- æœ€å¤§è¿æ¥æ•°ï¼š100
- è¿æ¥è¶…æ—¶ï¼š30ç§’

ç§’æ€åœºæ™¯ï¼š
- å¹¶å‘ç”¨æˆ·ï¼š1000äºº
- æ¯äººå¡«è¡¨æ—¶é—´ï¼š5åˆ†é’Ÿ
- éœ€è¦çš„è¿æ¥æ•°ï¼š1000ä¸ª âŒ

ç»“æœï¼š
- å‰100ä¸ªç”¨æˆ·å æ®æ‰€æœ‰è¿æ¥
- å900ä¸ªç”¨æˆ·å…¨éƒ¨è¶…æ—¶å¤±è´¥
- ç³»ç»Ÿå®Œå…¨ç˜«ç—ª
```

**å½±å“ï¼š**

- ğŸ”´ **æ•°æ®åº“è¿æ¥æ± è€—å°½**ï¼šæ–°ç”¨æˆ·æ— æ³•è·å–è¿æ¥
- ğŸ”´ **CPU èµ„æºæµªè´¹**ï¼šç»´æŠ¤å¤§é‡ç©ºé—²é•¿è¿æ¥
- ğŸ”´ **å†…å­˜å‹åŠ›å¢å¤§**ï¼šæ¯ä¸ªäº‹åŠ¡å ç”¨å†…å­˜ç¼“å­˜é”ä¿¡æ¯

**å®é™…æ•°æ®ï¼š**

| ç”¨æˆ·æ•° | è¿æ¥æ± å¤§å° | å¡«è¡¨æ—¶é•¿ | ç³»ç»ŸçŠ¶æ€          |
| ------ | ---------- | -------- | ----------------- |
| 100    | 100        | 5 åˆ†é’Ÿ   | ğŸŸ¡ ä¸´ç•ŒçŠ¶æ€       |
| 500    | 100        | 5 åˆ†é’Ÿ   | ğŸ”´ 400 äººç­‰å¾…è¶…æ—¶ |
| 1000   | 100        | 5 åˆ†é’Ÿ   | ğŸ”´ ç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨ |

---

##### 2. **é”äº‰ç”¨ä¸é˜»å¡**

**é—®é¢˜æè¿°ï¼š** å¤šç”¨æˆ·åŒæ—¶ç«äº‰åŒä¸€å¼ ç¥¨æ—¶ï¼Œä¼šå½¢æˆä¸¥é‡çš„é”ç­‰å¾…é“¾

**å…·ä½“åœºæ™¯ï¼š**

```sql
-- æ—¶é—´çº¿æ¼”ç¤º
T1 (10:00:00): ç”¨æˆ·Aå¼€å§‹äº‹åŠ¡ï¼Œé”å®šç¥¨åŠ¡12345
BEGIN;
SELECT * FROM tickets WHERE ticket_id = 12345 FOR UPDATE; âœ…
-- ç”¨æˆ·Aå¼€å§‹å¡«è¡¨...

T2 (10:00:01): ç”¨æˆ·Bå°è¯•é”å®šåŒä¸€å¼ ç¥¨
BEGIN;
SELECT * FROM tickets WHERE ticket_id = 12345 FOR UPDATE; â³ é˜»å¡ç­‰å¾…

T3 (10:00:02): ç”¨æˆ·Cä¹Ÿå°è¯•
BEGIN;
SELECT * FROM tickets WHERE ticket_id = 12345 FOR UPDATE; â³ é˜»å¡ç­‰å¾…

T4 (10:00:03): ç”¨æˆ·Dä¹Ÿå°è¯•
BEGIN;
SELECT * FROM tickets WHERE ticket_id = 12345 FOR UPDATE; â³ é˜»å¡ç­‰å¾…

...

T5 (10:05:00): ç”¨æˆ·Aå®Œæˆè´­ä¹°æˆ–è¶…æ—¶
COMMIT; -- é‡Šæ”¾é”

T6 (10:05:00): ç”¨æˆ·Bè·å¾—é”ï¼Œå…¶ä»–äººç»§ç»­ç­‰å¾…5åˆ†é’Ÿ...
```

**é›ªå´©æ•ˆåº”ï¼š**

```
çƒ­é—¨æ¼”å”±ä¼šåœºæ™¯ï¼š
- é»„é‡‘åº§ä½ç¥¨ï¼š100å¼ 
- æƒ³è¦çš„ç”¨æˆ·ï¼š10000äºº
- å¹³å‡å¡«è¡¨æ—¶é—´ï¼š5åˆ†é’Ÿ

è®¡ç®—ï¼š
ç¬¬1ä¸ªç”¨æˆ·ï¼š0åˆ†é’Ÿç­‰å¾…
ç¬¬2ä¸ªç”¨æˆ·ï¼š5åˆ†é’Ÿç­‰å¾…
ç¬¬3ä¸ªç”¨æˆ·ï¼š10åˆ†é’Ÿç­‰å¾…
...
ç¬¬100ä¸ªç”¨æˆ·ï¼š495åˆ†é’Ÿç­‰å¾…ï¼ˆ8.25å°æ—¶ï¼‰âŒ
ç¬¬101-10000ä¸ªç”¨æˆ·ï¼šå…¨éƒ¨ç™½ç­‰ï¼Œç¥¨å·²å”®ç½„ âŒ
```

**æ•°æ®åº“å±‚é¢ï¼š**

```
SHOW PROCESSLIST;

+----+------+------+------+---------+-------+
| Id | User | DB   | Time | State   | Info  |
+----+------+------+------+---------+-------+
| 1  | app  | shop | 298  | active  | SELECT FOR UPDATE |
| 2  | app  | shop | 295  | Locked  | SELECT FOR UPDATE |
| 3  | app  | shop | 290  | Locked  | SELECT FOR UPDATE |
| 4  | app  | shop | 285  | Locked  | SELECT FOR UPDATE |
...
| 99 | app  | shop | 5    | Locked  | SELECT FOR UPDATE |
+----+------+------+------+---------+-------+

99ä¸ªäº‹åŠ¡åœ¨æ’é˜Ÿç­‰å¾…ï¼
```

---

##### 3. **æ­»é”é£é™©**

**é—®é¢˜æè¿°ï¼š** å½“ç”¨æˆ·åŒæ—¶é¢„è®¢å¤šå¼ ç¥¨æ—¶ï¼Œå®¹æ˜“å½¢æˆå¾ªç¯ç­‰å¾…ï¼Œå¯¼è‡´æ­»é”

**æ­»é”åœºæ™¯ç¤ºä¾‹ï¼š**

```sql
-- ç”¨æˆ·Aï¼šæƒ³ä¹°ç¥¨12345å’Œç¥¨12346
T1: BEGIN;
T2: SELECT * FROM tickets WHERE ticket_id = 12345 FOR UPDATE; âœ… (Aé”å®š12345)
T3: -- ç”¨æˆ·Aå¡«å†™ç¬¬ä¸€å¼ ç¥¨ä¿¡æ¯...

-- ç”¨æˆ·Bï¼šæƒ³ä¹°ç¥¨12346å’Œç¥¨12345
T4: BEGIN;
T5: SELECT * FROM tickets WHERE ticket_id = 12346 FOR UPDATE; âœ… (Bé”å®š12346)
T6: -- ç”¨æˆ·Bå¡«å†™ç¬¬ä¸€å¼ ç¥¨ä¿¡æ¯...

-- ç”¨æˆ·Aç»§ç»­
T7: SELECT * FROM tickets WHERE ticket_id = 12346 FOR UPDATE; â³ (ç­‰å¾…Bé‡Šæ”¾)

-- ç”¨æˆ·Bç»§ç»­
T8: SELECT * FROM tickets WHERE ticket_id = 12345 FOR UPDATE; â³ (ç­‰å¾…Aé‡Šæ”¾)

-- å½¢æˆå¾ªç¯ç­‰å¾…ï¼šAç­‰Bï¼ŒBç­‰A
-- æ•°æ®åº“æ£€æµ‹åˆ°æ­»é”ï¼Œå¼ºåˆ¶å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡
T9: ERROR 1213: Deadlock found when trying to get lock; try restarting transaction
```

**æ­»é”æµç¨‹å›¾ï¼š**

```
ç”¨æˆ·AæŒæœ‰é”      ç”¨æˆ·BæŒæœ‰é”
    â”‚                â”‚
    â”‚   ç¥¨12345      â”‚   ç¥¨12346
    â”‚   â”Œâ”€â”€â”€â”€â”€â”      â”‚   â”Œâ”€â”€â”€â”€â”€â”
    â””â”€â”€â–ºâ”‚  ğŸ”’ â”‚      â””â”€â”€â–ºâ”‚  ğŸ”’ â”‚
        â””â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”˜
           â”‚                â”‚
           â”‚                â”‚
         ç­‰å¾…             ç­‰å¾…
           â”‚                â”‚
           â–¼                â–¼
        â”Œâ”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”
        â”‚  ğŸ”’ â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  ğŸ”’ â”‚
        â””â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”˜
        ç¥¨12346          ç¥¨12345
                â†‘
                â”‚
             æ­»é”ï¼ğŸ’¥
```

**æ­»é”ç»Ÿè®¡ï¼š**

| å¹¶å‘æ•° | å¤šç¥¨è®¢å•æ¯”ä¾‹ | æ­»é”ç‡ | ç”¨æˆ·å½±å“        |
| ------ | ------------ | ------ | --------------- |
| 100    | 10%          | 0.5%   | ğŸŸ¡ å¶å‘         |
| 500    | 30%          | 5%     | ğŸŸ¡ é¢‘ç¹å‡ºç°     |
| 1000   | 50%          | 15%    | ğŸ”´ å¤§é‡ç”¨æˆ·å¤±è´¥ |

---

#### ä¸ºä»€ä¹ˆä¸æ¨èï¼Ÿ

> ğŸ’¡ **æ ¸å¿ƒé—®é¢˜**ï¼šæ•°æ®åº“é”çš„è®¾è®¡åˆè¡·æ˜¯ç”¨äº**å¾®ç§’çº§**çš„çŸ­äº‹åŠ¡ï¼Œè€Œä¸æ˜¯**åˆ†é’Ÿçº§**çš„ç”¨æˆ·äº¤äº’ã€‚

**æ—¶é—´å°ºåº¦å¯¹æ¯”ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®åº“é”çš„ç†æƒ³ä½¿ç”¨æ—¶é•¿                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–ˆâ–ˆâ–ˆâ–ˆ < 100msï¼ˆ0.1ç§’ï¼‰                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·å¡«è¡¨å®é™…æ—¶é•¿                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ... â”‚
â”‚ ...â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 300,000msï¼ˆ5åˆ†é’Ÿï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ—¶é—´å·®è·ï¼š3000å€ âŒ
```

**ç±»æ¯”è¯´æ˜ï¼š**

è¿™å°±åƒæ˜¯ï¼š

- ğŸš— ç”¨ F1 èµ›è½¦å»é€å¤–å–ï¼ˆå·¥å…·ä¸åœºæ™¯ä¸åŒ¹é…ï¼‰
- ğŸ”¨ ç”¨æ‰‹æœ¯åˆ€å»ç æ ‘ï¼ˆç²¾å¯†å·¥å…·ç”¨äºç²—æ´»ï¼‰
- âš¡ è®©çŸ­è·‘è¿åŠ¨å‘˜è·‘é©¬æ‹‰æ¾ï¼ˆä¸é€‚åˆé•¿æ—¶é—´ä»»åŠ¡ï¼‰

**ç»“è®ºï¼š**

| æ–¹é¢     | æ•°æ®åº“é”è®¾è®¡ç›®æ ‡ | å®é™…ä½¿ç”¨åœºæ™¯ | åŒ¹é…åº¦    |
| -------- | ---------------- | ------------ | --------- |
| **æ—¶é•¿** | æ¯«ç§’çº§           | åˆ†é’Ÿçº§       | âŒ ä¸åŒ¹é… |
| **å¹¶å‘** | é«˜å¹¶å‘çŸ­äº‹åŠ¡     | å°‘é‡é•¿äº‹åŠ¡   | âŒ ä¸åŒ¹é… |
| **èµ„æº** | å¿«é€Ÿé‡Šæ”¾         | é•¿æœŸå ç”¨     | âŒ ä¸åŒ¹é… |
| **åœºæ™¯** | æ•°æ®ä¸€è‡´æ€§ä¿æŠ¤   | ç”¨æˆ·äº¤äº’ç­‰å¾… | âŒ ä¸åŒ¹é… |

> âš ï¸ **è­¦å‘Š**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨é•¿æ—¶é—´æ•°æ®åº“é”å¯èƒ½å¯¼è‡´ï¼š
>
> - ç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨
> - å¤§è§„æ¨¡ç”¨æˆ·æŠ•è¯‰
> - æ•°æ®åº“éœ€è¦ç´§æ€¥é‡å¯
> - æ½œåœ¨çš„ä¸šåŠ¡æŸå¤±

**æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆï¼š** è¯·ä½¿ç”¨æ–¹æ¡ˆäºŒæˆ–æ–¹æ¡ˆä¸‰ï¼ˆæ¨èï¼‰

---

### æ–¹æ¡ˆäºŒï¼šçŠ¶æ€å­—æ®µ + è¿‡æœŸæ—¶é—´ + å®šæ—¶ä»»åŠ¡

#### å®ç°åŸç†

é€šè¿‡åœ¨ç¥¨åŠ¡è¡¨ä¸­æ·»åŠ **çŠ¶æ€å­—æ®µ**å’Œ**è¿‡æœŸæ—¶é—´æˆ³**æ¥ç®¡ç†é¢„ç•™ã€‚

#### æ•°æ®åº“è®¾è®¡

```sql
CREATE TABLE tickets (
    ticket_id BIGINT PRIMARY KEY,
    event_id BIGINT NOT NULL,
    seat_number VARCHAR(10),
    status VARCHAR(20) NOT NULL, -- 'AVAILABLE', 'RESERVED', 'BOOKED'
    reserved_by BIGINT,           -- é¢„ç•™ç”¨æˆ·ID
    reserved_at TIMESTAMP,        -- é¢„ç•™æ—¶é—´
    expires_at TIMESTAMP,         -- è¿‡æœŸæ—¶é—´
    price DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_status (status),
    INDEX idx_expires_at (expires_at)
);
```

#### çŠ¶æ€æµè½¬å›¾

```
[AVAILABLE] â”€â”€ç”¨æˆ·é€‰æ‹©â”€â”€> [RESERVED] â”€â”€å®Œæˆæ”¯ä»˜â”€â”€> [BOOKED]
     â†‘                         â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€è¶…æ—¶è¿‡æœŸâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é¢„ç•™æµç¨‹

**Step 1: ç”¨æˆ·é€‰æ‹©ç¥¨åŠ¡**

```sql
BEGIN;

-- æ£€æŸ¥ç¥¨åŠ¡æ˜¯å¦å¯ç”¨
SELECT * FROM tickets
WHERE ticket_id = 12345
AND status = 'AVAILABLE'
FOR UPDATE;

-- æ›´æ–°ä¸ºé¢„ç•™çŠ¶æ€
UPDATE tickets
SET status = 'RESERVED',
    reserved_by = 67890,
    reserved_at = CURRENT_TIMESTAMP,
    expires_at = CURRENT_TIMESTAMP + INTERVAL '10 minutes'
WHERE ticket_id = 12345;

COMMIT;
```

**Step 2: ç”¨æˆ·å®Œæˆæ”¯ä»˜**

```sql
UPDATE tickets
SET status = 'BOOKED'
WHERE ticket_id = 12345
AND reserved_by = 67890
AND status = 'RESERVED';
```

#### è¿‡æœŸå¤„ç†æ–¹æ¡ˆ

**æ–¹æ¡ˆ 2Aï¼šå®šæ—¶ä»»åŠ¡ï¼ˆCron Jobï¼‰**

```python
# æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
@scheduled(cron="0 * * * * *")
def release_expired_reservations():
    """é‡Šæ”¾è¿‡æœŸçš„é¢„ç•™ç¥¨åŠ¡"""
    current_time = datetime.now()

    # æ‰¹é‡æ›´æ–°è¿‡æœŸç¥¨åŠ¡
    query = """
        UPDATE tickets
        SET status = 'AVAILABLE',
            reserved_by = NULL,
            reserved_at = NULL,
            expires_at = NULL
        WHERE status = 'RESERVED'
        AND expires_at < %s
    """

    affected_rows = db.execute(query, [current_time])
    logger.info(f"Released {affected_rows} expired tickets")
```

**æ–¹æ¡ˆ 2Bï¼šæŒ‰éœ€æ£€æŸ¥ï¼ˆOn-Demandï¼‰**

```python
def get_available_tickets(event_id):
    """è·å–å¯ç”¨ç¥¨åŠ¡ï¼ˆå®æ—¶æ£€æŸ¥è¿‡æœŸï¼‰"""
    query = """
        SELECT * FROM tickets
        WHERE event_id = %s
        AND (
            status = 'AVAILABLE'
            OR (status = 'RESERVED' AND expires_at < CURRENT_TIMESTAMP)
        )
        ORDER BY seat_number
    """
    return db.query(query, [event_id])
```

#### âš ï¸ æŒ‘æˆ˜ä¸å±€é™

| æŒ‘æˆ˜           | æè¿°                       | å½±å“ç¨‹åº¦          |
| -------------- | -------------------------- | ----------------- |
| **è§£é”å»¶è¿Ÿ**   | å®šæ—¶ä»»åŠ¡æ‰§è¡Œé—´éš”å¯¼è‡´çš„å»¶è¿Ÿ | ğŸ”´ é«˜ï¼ˆçƒ­é—¨å•†å“ï¼‰ |
| **å¯é æ€§é£é™©** | å®šæ—¶ä»»åŠ¡å¤±è´¥å¯¼è‡´ç³»ç»Ÿç´Šä¹±   | ğŸ”´ é«˜             |
| **èµ„æºæµªè´¹**   | è¿‡æœŸç¥¨åŠ¡æœªåŠæ—¶é‡Šæ”¾         | ğŸŸ¡ ä¸­             |
| **æŸ¥è¯¢å¤æ‚åº¦** | éœ€è¦æ£€æŸ¥å¤šä¸ªæ¡ä»¶           | ğŸŸ¡ ä¸­             |

**å…·ä½“é—®é¢˜åˆ†æï¼š**

```
ç¥¨åŠ¡è¿‡æœŸæ—¶é—´ï¼š10:00:00
å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼š10:01:00
å®é™…é‡Šæ”¾å»¶è¿Ÿï¼š60ç§’

åœ¨çƒ­é—¨æ¼”å”±ä¼šåœºæ™¯ä¸‹ï¼š
- 1000äººç­‰å¾…è¿™å¼ ç¥¨
- æ¯äººæŸå¤±60ç§’
- æ€»è®¡æŸå¤±ï¼š16.7å°æ—¶çš„ç­‰å¾…æ—¶é—´ âŒ
```

---

### æ–¹æ¡ˆä¸‰ï¼šåŒå±æ€§æ£€æŸ¥ + çŸ­äº‹åŠ¡ï¼ˆæ¨èï¼‰

#### æ ¸å¿ƒæ€æƒ³

> ğŸ’¡ **å…³é”®åˆ›æ–°**ï¼šç¥¨åŠ¡çš„"å¯ç”¨æ€§"ç”±ä¸¤ä¸ªæ¡ä»¶å†³å®šï¼š
>
> 1. `status = 'AVAILABLE'`ï¼ˆæ˜¾å¼å¯ç”¨ï¼‰
> 2. `status = 'RESERVED' AND expires_at < NOW()`ï¼ˆéšå¼å¯ç”¨ï¼‰

#### å®ç°åŸç†

ä½¿ç”¨**çŸ­äº‹åŠ¡**é…åˆ**åŒæ¡ä»¶æ£€æŸ¥**ï¼Œæ— éœ€ä¾èµ–å®šæ—¶ä»»åŠ¡å³å¯å®ç°å³æ—¶è¿‡æœŸã€‚

#### é¢„ç•™æ“ä½œï¼ˆæ ¸å¿ƒä»£ç ï¼‰

```sql
BEGIN;

-- æ£€æŸ¥ç¥¨åŠ¡æ˜¯å¦å¯ç”¨ï¼ˆæ˜¾å¼æˆ–éšå¼ï¼‰
SELECT * FROM tickets
WHERE ticket_id = 12345
AND (
    status = 'AVAILABLE'
    OR (status = 'RESERVED' AND expires_at < CURRENT_TIMESTAMP)
)
FOR UPDATE;

-- å¦‚æœæŸ¥åˆ°è®°å½•ï¼Œè¯´æ˜ç¥¨åŠ¡å¯ç”¨
IF FOUND THEN
    UPDATE tickets
    SET status = 'RESERVED',
        reserved_by = 67890,
        reserved_at = CURRENT_TIMESTAMP,
        expires_at = CURRENT_TIMESTAMP + INTERVAL '10 minutes'
    WHERE ticket_id = 12345;

    COMMIT;
    RETURN 'SUCCESS';
ELSE
    ROLLBACK;
    RETURN 'TICKET_NOT_AVAILABLE';
END IF;
```

#### å®Œæ•´ä¸šåŠ¡æµç¨‹

**1. ç”¨æˆ·æµè§ˆå¯ç”¨ç¥¨åŠ¡**

```sql
-- æŸ¥è¯¢æ‰€æœ‰å®é™…å¯ç”¨çš„ç¥¨åŠ¡
SELECT ticket_id, seat_number, price
FROM tickets
WHERE event_id = 100
AND (
    status = 'AVAILABLE'
    OR (status = 'RESERVED' AND expires_at < CURRENT_TIMESTAMP)
)
ORDER BY seat_number;
```

**2. ç”¨æˆ·é€‰æ‹©å¹¶é¢„ç•™**

```python
def reserve_ticket(ticket_id, user_id, hold_minutes=10):
    """é¢„ç•™ç¥¨åŠ¡"""
    try:
        with db.transaction() as tx:
            # åŒæ¡ä»¶æ£€æŸ¥ + è¡Œé”
            ticket = tx.execute("""
                SELECT * FROM tickets
                WHERE ticket_id = %s
                AND (
                    status = 'AVAILABLE'
                    OR (status = 'RESERVED' AND expires_at < CURRENT_TIMESTAMP)
                )
                FOR UPDATE
            """, [ticket_id])

            if not ticket:
                return {
                    'success': False,
                    'error': 'TICKET_NOT_AVAILABLE'
                }

            # æ›´æ–°é¢„ç•™ä¿¡æ¯
            tx.execute("""
                UPDATE tickets
                SET status = 'RESERVED',
                    reserved_by = %s,
                    reserved_at = CURRENT_TIMESTAMP,
                    expires_at = CURRENT_TIMESTAMP + INTERVAL '%s minutes'
                WHERE ticket_id = %s
            """, [user_id, hold_minutes, ticket_id])

            tx.commit()

            return {
                'success': True,
                'expires_at': ticket['expires_at'] + timedelta(minutes=hold_minutes)
            }

    except Exception as e:
        logger.error(f"Reserve failed: {e}")
        return {'success': False, 'error': 'SYSTEM_ERROR'}
```

**3. ç”¨æˆ·å®Œæˆæ”¯ä»˜**

```python
def complete_purchase(ticket_id, user_id, payment_info):
    """å®Œæˆè´­ä¹°"""
    try:
        with db.transaction() as tx:
            # éªŒè¯é¢„ç•™çŠ¶æ€
            ticket = tx.execute("""
                SELECT * FROM tickets
                WHERE ticket_id = %s
                AND reserved_by = %s
                AND status = 'RESERVED'
                AND expires_at > CURRENT_TIMESTAMP
                FOR UPDATE
            """, [ticket_id, user_id])

            if not ticket:
                return {
                    'success': False,
                    'error': 'RESERVATION_EXPIRED'
                }

            # å¤„ç†æ”¯ä»˜ï¼ˆç®€åŒ–ï¼‰
            payment_result = process_payment(payment_info)

            if not payment_result['success']:
                return {
                    'success': False,
                    'error': 'PAYMENT_FAILED'
                }

            # æ›´æ–°ä¸ºå·²è®¢çŠ¶æ€
            tx.execute("""
                UPDATE tickets
                SET status = 'BOOKED',
                    booked_at = CURRENT_TIMESTAMP
                WHERE ticket_id = %s
            """, [ticket_id])

            tx.commit()

            return {'success': True, 'booking_id': ticket['ticket_id']}

    except Exception as e:
        logger.error(f"Purchase failed: {e}")
        return {'success': False, 'error': 'SYSTEM_ERROR'}
```

**4. ç”¨æˆ·å–æ¶ˆé¢„ç•™**

```python
def cancel_reservation(ticket_id, user_id):
    """ä¸»åŠ¨å–æ¶ˆé¢„ç•™"""
    result = db.execute("""
        UPDATE tickets
        SET status = 'AVAILABLE',
            reserved_by = NULL,
            reserved_at = NULL,
            expires_at = NULL
        WHERE ticket_id = %s
        AND reserved_by = %s
        AND status = 'RESERVED'
    """, [ticket_id, user_id])

    return result.rowcount > 0
```

#### æ€§èƒ½ä¼˜åŒ–

**1. å¤åˆç´¢å¼•**

```sql
-- ä¼˜åŒ–åŒæ¡ä»¶æŸ¥è¯¢
CREATE INDEX idx_ticket_availability
ON tickets(event_id, status, expires_at)
WHERE status IN ('AVAILABLE', 'RESERVED');

-- ä¼˜åŒ–ç”¨æˆ·æŸ¥è¯¢
CREATE INDEX idx_user_reservations
ON tickets(reserved_by, status, expires_at);
```

**2. ç‰©åŒ–è§†å›¾ï¼ˆå¯é€‰ï¼‰**

```sql
CREATE MATERIALIZED VIEW available_tickets AS
SELECT
    ticket_id,
    event_id,
    seat_number,
    price,
    CASE
        WHEN status = 'AVAILABLE' THEN TRUE
        WHEN status = 'RESERVED' AND expires_at < CURRENT_TIMESTAMP THEN TRUE
        ELSE FALSE
    END AS is_available
FROM tickets;

-- å®šæœŸåˆ·æ–°ï¼ˆéå…³é”®è·¯å¾„ï¼‰
REFRESH MATERIALIZED VIEW CONCURRENTLY available_tickets;
```

**3. ç¼“å­˜ç­–ç•¥**

```python
from redis import Redis
cache = Redis()

def get_available_count(event_id):
    """è·å–å¯ç”¨ç¥¨æ•°ï¼ˆç¼“å­˜ï¼‰"""
    cache_key = f"event:{event_id}:available_count"

    # å°è¯•ä»ç¼“å­˜è·å–
    count = cache.get(cache_key)
    if count is not None:
        return int(count)

    # æŸ¥è¯¢æ•°æ®åº“
    count = db.scalar("""
        SELECT COUNT(*) FROM tickets
        WHERE event_id = %s
        AND (
            status = 'AVAILABLE'
            OR (status = 'RESERVED' AND expires_at < CURRENT_TIMESTAMP)
        )
    """, [event_id])

    # ç¼“å­˜5ç§’
    cache.setex(cache_key, 5, count)
    return count
```

#### âœ… ä¼˜åŠ¿

| ä¼˜åŠ¿           | è¯´æ˜                                 |
| -------------- | ------------------------------------ |
| **å³æ—¶è¿‡æœŸ**   | æ— éœ€ç­‰å¾…å®šæ—¶ä»»åŠ¡ï¼Œè¿‡æœŸç«‹å³ç”Ÿæ•ˆ       |
| **çŸ­äº‹åŠ¡**     | äº‹åŠ¡æ—¶é•¿ < 100msï¼Œç¬¦åˆæ•°æ®åº“æœ€ä½³å®è·µ |
| **é«˜å¹¶å‘**     | æ”¯æŒæ°´å¹³æ‰©å±•ï¼Œé€‚åˆç§’æ€åœºæ™¯           |
| **ç®€åŒ–è¿ç»´**   | ä¸ä¾èµ–å®šæ—¶ä»»åŠ¡çš„å¯é æ€§               |
| **æ•°æ®ä¸€è‡´æ€§** | é€šè¿‡æ•°æ®åº“äº‹åŠ¡ä¿è¯                   |

#### âš ï¸ æ³¨æ„äº‹é¡¹

| æ³¨æ„ç‚¹         | è§£å†³æ–¹æ¡ˆ                       |
| -------------- | ------------------------------ |
| **æŸ¥è¯¢æ€§èƒ½**   | ä½¿ç”¨å¤åˆç´¢å¼•ä¼˜åŒ–åŒæ¡ä»¶æŸ¥è¯¢     |
| **æ•°æ®å¯è¯»æ€§** | å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®ï¼ˆéå…³é”®è·¯å¾„ï¼‰ |
| **ç´¢å¼•ç»´æŠ¤**   | ç›‘æ§ç´¢å¼•è†¨èƒ€ï¼Œå®šæœŸ VACUUM      |

#### åå°æ¸…ç†ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰

è™½ç„¶ç³»ç»Ÿé€»è¾‘ä¸ä¾èµ–æ¸…ç†ä»»åŠ¡ï¼Œä½†ä¸ºäº†æ•°æ®æ•´æ´ï¼Œå¯ä»¥å®šæœŸæ¸…ç†ï¼š

```python
@scheduled(cron="0 0 * * * *")  # æ¯å°æ—¶æ‰§è¡Œ
def cleanup_expired_reservations():
    """æ¸…ç†è¿‡æœŸé¢„ç•™æ•°æ®ï¼ˆä¸å½±å“ä¸šåŠ¡é€»è¾‘ï¼‰"""
    query = """
        UPDATE tickets
        SET status = 'AVAILABLE',
            reserved_by = NULL,
            reserved_at = NULL,
            expires_at = NULL
        WHERE status = 'RESERVED'
        AND expires_at < CURRENT_TIMESTAMP - INTERVAL '1 hour'
    """

    affected_rows = db.execute(query)
    logger.info(f"Cleaned up {affected_rows} expired reservations")
```

> ğŸ’¡ **å…³é”®åŒºåˆ«**ï¼šå³ä½¿è¿™ä¸ªæ¸…ç†ä»»åŠ¡å¤±è´¥æˆ–å»¶è¿Ÿï¼Œä¹Ÿ**ä¸ä¼šå½±å“**ç³»ç»Ÿçš„æ­£ç¡®æ€§å’Œå¯ç”¨æ€§ã€‚

---

### æ–¹æ¡ˆå››ï¼šRedis åˆ†å¸ƒå¼é”ï¼ˆé«˜å¹¶å‘æ¨èï¼‰

#### æ ¸å¿ƒæ€æƒ³

> ğŸ’¡ **å…³é”®åˆ›æ–°**ï¼šå°†é”ä»æ•°æ®åº“å±‚é¢ä¸Šç§»åˆ°ç¼“å­˜å±‚é¢ï¼Œåˆ©ç”¨ Redis çš„é«˜æ€§èƒ½å’ŒåŸå­æ“ä½œå®ç°ç¥¨åŠ¡é”å®šã€‚
>
> - æ¯å¼ ç¥¨åœ¨ Redis ä¸­å¯¹åº”ä¸€ä¸ªå¸¦æœ‰è¿‡æœŸæ—¶é—´çš„ key
> - æŸ¥è¯¢æ—¶å…ˆæ£€æŸ¥ Redis é”çŠ¶æ€ï¼Œé¿å…æ•°æ®åº“å‹åŠ›
> - è‡ªåŠ¨è¿‡æœŸæœºåˆ¶ï¼Œæ— éœ€å®šæ—¶ä»»åŠ¡æ¸…ç†

#### å®ç°åŸç†

ä½¿ç”¨ **Redis åˆ†å¸ƒå¼é”** + **æ•°æ®åº“çŠ¶æ€åŒæ­¥**ï¼Œå°†é«˜é¢‘çš„é”æ£€æŸ¥æ“ä½œä»æ•°æ®åº“è½¬ç§»åˆ° Redisã€‚

#### æ•°æ®åº“è®¾è®¡

```sql
CREATE TABLE tickets (
    ticket_id BIGINT PRIMARY KEY,
    event_id BIGINT NOT NULL,
    seat_number VARCHAR(10),
    status VARCHAR(20) NOT NULL, -- 'AVAILABLE', 'BOOKED'
    booked_by BIGINT,
    booked_at TIMESTAMP,
    price DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_event_status (event_id, status)
);
```

#### Redis é”ç»“æ„

```python
# Redis Key-Value è®¾è®¡
Key:   "ticket:lock:{ticket_id}"
Value: "{user_id}"
TTL:   600 (10åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ)

# ç¤ºä¾‹
Key:   "ticket:lock:12345"
Value: "67890"
TTL:   600
```

#### é¢„ç•™æµç¨‹ï¼ˆæ ¸å¿ƒå®ç°ï¼‰

**Step 1: æŸ¥è¯¢å¯ç”¨ç¥¨åŠ¡**

```python
from redis import Redis
import time

redis_client = Redis(host='localhost', port=6379, decode_responses=True)

def get_available_tickets(event_id):
    """è·å–å¯ç”¨ç¥¨åŠ¡åˆ—è¡¨"""
    # ä»æ•°æ®åº“è·å–æ‰€æœ‰æœªé”å®šçš„ç¥¨
    db_tickets = db.query("""
        SELECT ticket_id, seat_number, price
        FROM tickets
        WHERE event_id = %s
        AND status = 'AVAILABLE'
        ORDER BY seat_number
    """, [event_id])

    available_tickets = []

    for ticket in db_tickets:
        ticket_id = ticket['ticket_id']
        lock_key = f"ticket:lock:{ticket_id}"

        # æ£€æŸ¥ Redis ä¸­æ˜¯å¦è¢«é”å®š
        if not redis_client.exists(lock_key):
            available_tickets.append(ticket)

    return available_tickets
```

**Step 2: å°è¯•é”å®šç¥¨åŠ¡**

```python
def reserve_ticket(ticket_id, user_id, hold_minutes=10):
    """
    ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”é¢„ç•™ç¥¨åŠ¡

    Args:
        ticket_id: ç¥¨åŠ¡ID
        user_id: ç”¨æˆ·ID
        hold_minutes: é”å®šæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰

    Returns:
        dict: é¢„ç•™ç»“æœ
    """
    lock_key = f"ticket:lock:{ticket_id}"
    ttl_seconds = hold_minutes * 60

    try:
        # 1. æ£€æŸ¥æ•°æ®åº“ä¸­ç¥¨åŠ¡çŠ¶æ€
        ticket = db.query_one("""
            SELECT * FROM tickets
            WHERE ticket_id = %s
            AND status = 'AVAILABLE'
            FOR UPDATE
        """, [ticket_id])

        if not ticket:
            return {
                'success': False,
                'error': 'TICKET_NOT_AVAILABLE_IN_DB'
            }

        # 2. å°è¯•åœ¨ Redis ä¸­è·å–é”ï¼ˆä½¿ç”¨ SET NX EX ä¿è¯åŸå­æ€§ï¼‰
        lock_acquired = redis_client.set(
            lock_key,
            user_id,
            nx=True,  # Only set if key does not exist
            ex=ttl_seconds  # Set expiry time
        )

        if not lock_acquired:
            # æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·æŒæœ‰çš„é”
            current_holder = redis_client.get(lock_key)
            if current_holder == str(user_id):
                # ç»­æœŸç°æœ‰é”
                redis_client.expire(lock_key, ttl_seconds)
                return {
                    'success': True,
                    'message': 'LOCK_RENEWED',
                    'expires_in': ttl_seconds
                }
            else:
                return {
                    'success': False,
                    'error': 'TICKET_LOCKED_BY_OTHER_USER'
                }

        # 3. é”å®šæˆåŠŸï¼Œè®°å½•é”å®šä¿¡æ¯åˆ° Redis Hashï¼ˆå¯é€‰ï¼Œç”¨äºæŸ¥è¯¢ï¼‰
        redis_client.hset(
            f"user:reservations:{user_id}",
            ticket_id,
            time.time()
        )
        redis_client.expire(f"user:reservations:{user_id}", ttl_seconds)

        return {
            'success': True,
            'ticket_id': ticket_id,
            'expires_in': ttl_seconds,
            'expires_at': time.time() + ttl_seconds
        }

    except Exception as e:
        logger.error(f"Reserve ticket failed: {e}")
        # å¦‚æœå‡ºé”™ï¼Œæ¸…ç† Redis é”
        redis_client.delete(lock_key)
        return {
            'success': False,
            'error': 'SYSTEM_ERROR'
        }
```

**Step 3: å®Œæˆæ”¯ä»˜**

```python
def complete_purchase(ticket_id, user_id, payment_info):
    """
    å®Œæˆè´­ä¹°å¹¶é‡Šæ”¾ Redis é”

    Args:
        ticket_id: ç¥¨åŠ¡ID
        user_id: ç”¨æˆ·ID
        payment_info: æ”¯ä»˜ä¿¡æ¯

    Returns:
        dict: è´­ä¹°ç»“æœ
    """
    lock_key = f"ticket:lock:{ticket_id}"

    try:
        # 1. éªŒè¯ Redis é”çš„æ‰€æœ‰æƒ
        current_holder = redis_client.get(lock_key)
        if current_holder != str(user_id):
            return {
                'success': False,
                'error': 'LOCK_NOT_OWNED_OR_EXPIRED'
            }

        # 2. ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡å®Œæˆè´­ä¹°
        with db.transaction() as tx:
            # å†æ¬¡éªŒè¯ç¥¨åŠ¡çŠ¶æ€
            ticket = tx.execute("""
                SELECT * FROM tickets
                WHERE ticket_id = %s
                AND status = 'AVAILABLE'
                FOR UPDATE
            """, [ticket_id])

            if not ticket:
                # ç¥¨å·²è¢«å…¶ä»–äººè´­ä¹°ï¼ˆå¼‚å¸¸æƒ…å†µï¼‰
                redis_client.delete(lock_key)
                return {
                    'success': False,
                    'error': 'TICKET_ALREADY_BOOKED'
                }

            # 3. å¤„ç†æ”¯ä»˜
            payment_result = process_payment(payment_info)
            if not payment_result['success']:
                return {
                    'success': False,
                    'error': 'PAYMENT_FAILED'
                }

            # 4. æ›´æ–°æ•°æ®åº“çŠ¶æ€
            tx.execute("""
                UPDATE tickets
                SET status = 'BOOKED',
                    booked_by = %s,
                    booked_at = CURRENT_TIMESTAMP
                WHERE ticket_id = %s
            """, [user_id, ticket_id])

            tx.commit()

        # 5. é‡Šæ”¾ Redis é”ï¼ˆä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§ï¼‰
        release_lock_script = """
        if redis.call("get", KEYS[1]) == ARGV[1] then
            return redis.call("del", KEYS[1])
        else
            return 0
        end
        """
        redis_client.eval(release_lock_script, 1, lock_key, str(user_id))

        # 6. æ¸…ç†ç”¨æˆ·é¢„ç•™è®°å½•
        redis_client.hdel(f"user:reservations:{user_id}", ticket_id)

        return {
            'success': True,
            'ticket_id': ticket_id,
            'booking_id': ticket['ticket_id']
        }

    except Exception as e:
        logger.error(f"Complete purchase failed: {e}")
        return {
            'success': False,
            'error': 'SYSTEM_ERROR'
        }
```

**Step 4: ä¸»åŠ¨å–æ¶ˆé¢„ç•™**

```python
def cancel_reservation(ticket_id, user_id):
    """
    ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆé¢„ç•™ï¼Œé‡Šæ”¾é”

    Args:
        ticket_id: ç¥¨åŠ¡ID
        user_id: ç”¨æˆ·ID

    Returns:
        bool: æ˜¯å¦æˆåŠŸå–æ¶ˆ
    """
    lock_key = f"ticket:lock:{ticket_id}"

    # ä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§ï¼šåªæœ‰é”çš„æŒæœ‰è€…æ‰èƒ½é‡Šæ”¾
    release_script = """
    if redis.call("get", KEYS[1]) == ARGV[1] then
        redis.call("del", KEYS[1])
        return 1
    else
        return 0
    end
    """

    result = redis_client.eval(release_script, 1, lock_key, str(user_id))

    if result:
        redis_client.hdel(f"user:reservations:{user_id}", ticket_id)
        logger.info(f"User {user_id} released lock on ticket {ticket_id}")
        return True
    else:
        logger.warning(f"User {user_id} tried to release lock on ticket {ticket_id} but doesn't own it")
        return False
```

**Step 5: æŸ¥è¯¢ç”¨æˆ·çš„é¢„ç•™ä¿¡æ¯**

```python
def get_user_reservations(user_id):
    """
    è·å–ç”¨æˆ·å½“å‰çš„æ‰€æœ‰é¢„ç•™

    Args:
        user_id: ç”¨æˆ·ID

    Returns:
        list: é¢„ç•™çš„ç¥¨åŠ¡åˆ—è¡¨
    """
    reservation_key = f"user:reservations:{user_id}"
    ticket_ids = redis_client.hkeys(reservation_key)

    reservations = []

    for ticket_id in ticket_ids:
        lock_key = f"ticket:lock:{ticket_id}"
        ttl = redis_client.ttl(lock_key)

        if ttl > 0:  # é”è¿˜æœ‰æ•ˆ
            # ä»æ•°æ®åº“è·å–ç¥¨åŠ¡è¯¦æƒ…
            ticket = db.query_one("""
                SELECT ticket_id, seat_number, price, event_id
                FROM tickets
                WHERE ticket_id = %s
            """, [ticket_id])

            if ticket:
                reservations.append({
                    'ticket_id': ticket_id,
                    'seat_number': ticket['seat_number'],
                    'price': ticket['price'],
                    'expires_in': ttl,
                    'expires_at': time.time() + ttl
                })
        else:
            # é”å·²è¿‡æœŸï¼Œæ¸…ç†è®°å½•
            redis_client.hdel(reservation_key, ticket_id)

    return reservations
```

#### æ¶æ„æµç¨‹å›¾

```
ç”¨æˆ·æŸ¥è¯¢ç¥¨åŠ¡
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŸ¥è¯¢æ•°æ®åº“    â”‚  status = 'AVAILABLE'
â”‚ è·å–ç¥¨åŠ¡åˆ—è¡¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿‡æ»¤ Redis é” â”‚  æ£€æŸ¥ ticket:lock:{id} æ˜¯å¦å­˜åœ¨
â”‚ è¿”å›å¯ç”¨ç¥¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
    ç”¨æˆ·é€‰æ‹©ç¥¨åŠ¡
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SET NX EX    â”‚  åŸå­æ“ä½œé”å®šç¥¨åŠ¡
â”‚ è·å– Redis é” â”‚  TTL = 10 åˆ†é’Ÿ
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€æˆåŠŸâ”€â”€â”€â”€> ç”¨æˆ·å¡«å†™è¡¨å•ï¼ˆ10åˆ†é’Ÿå†…ï¼‰
        â”‚               â”‚
        â”‚               â–¼
        â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          â”‚ å®Œæˆæ”¯ä»˜      â”‚
        â”‚          â”‚ æ›´æ–°æ•°æ®åº“    â”‚  status = 'BOOKED'
        â”‚          â”‚ é‡Šæ”¾ Redis é” â”‚  DEL ticket:lock:{id}
        â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â””â”€å¤±è´¥â”€â”€â”€â”€> æç¤ºç¥¨å·²è¢«é”å®šï¼Œé€‰æ‹©å…¶ä»–ç¥¨

    è‡ªåŠ¨è¿‡æœŸï¼ˆ10åˆ†é’Ÿï¼‰
        â”‚
        â–¼
    Redis è‡ªåŠ¨åˆ é™¤ Key
    å…¶ä»–ç”¨æˆ·å¯ä»¥çœ‹åˆ°è¯¥ç¥¨
```

#### ä¼˜åŒ–ç­–ç•¥

**1. æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–**

```python
def get_available_tickets_optimized(event_id, limit=100):
    """
    ä¼˜åŒ–çš„æ‰¹é‡æŸ¥è¯¢ï¼šä½¿ç”¨ Redis Pipeline
    """
    # ä»æ•°æ®åº“è·å–å€™é€‰ç¥¨åŠ¡
    tickets = db.query("""
        SELECT ticket_id, seat_number, price
        FROM tickets
        WHERE event_id = %s AND status = 'AVAILABLE'
        ORDER BY seat_number
        LIMIT %s
    """, [event_id, limit * 2])  # è·å–2å€æ•°é‡ï¼Œé˜²æ­¢è¿‡æ»¤åä¸å¤Ÿ

    # ä½¿ç”¨ Pipeline æ‰¹é‡æ£€æŸ¥é”çŠ¶æ€
    pipe = redis_client.pipeline()
    for ticket in tickets:
        pipe.exists(f"ticket:lock:{ticket['ticket_id']}")

    lock_statuses = pipe.execute()

    # è¿‡æ»¤å‡ºçœŸæ­£å¯ç”¨çš„ç¥¨
    available_tickets = [
        ticket for ticket, is_locked in zip(tickets, lock_statuses)
        if not is_locked
    ]

    return available_tickets[:limit]
```

**2. é”ç»­æœŸæœºåˆ¶**

```python
def extend_reservation(ticket_id, user_id, extra_minutes=5):
    """
    ç”¨æˆ·è¯·æ±‚å»¶é•¿é¢„ç•™æ—¶é—´

    Args:
        ticket_id: ç¥¨åŠ¡ID
        user_id: ç”¨æˆ·ID
        extra_minutes: å»¶é•¿æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰

    Returns:
        dict: å»¶é•¿ç»“æœ
    """
    lock_key = f"ticket:lock:{ticket_id}"

    # ä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§
    extend_script = """
    if redis.call("get", KEYS[1]) == ARGV[1] then
        local ttl = redis.call("ttl", KEYS[1])
        if ttl > 0 then
            redis.call("expire", KEYS[1], ttl + tonumber(ARGV[2]))
            return ttl + tonumber(ARGV[2])
        else
            return -1
        end
    else
        return 0
    end
    """

    new_ttl = redis_client.eval(
        extend_script,
        1,
        lock_key,
        str(user_id),
        extra_minutes * 60
    )

    if new_ttl > 0:
        return {
            'success': True,
            'new_expires_in': new_ttl
        }
    elif new_ttl == 0:
        return {
            'success': False,
            'error': 'LOCK_NOT_OWNED'
        }
    else:
        return {
            'success': False,
            'error': 'LOCK_EXPIRED'
        }
```

**3. Redis é«˜å¯ç”¨é…ç½®**

```python
# Redis Sentinel é…ç½®ï¼ˆä¸»ä» + è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼‰
from redis.sentinel import Sentinel

sentinel = Sentinel(
    [
        ('sentinel1.example.com', 26379),
        ('sentinel2.example.com', 26379),
        ('sentinel3.example.com', 26379)
    ],
    socket_timeout=0.5
)

# è·å–ä¸»èŠ‚ç‚¹è¿æ¥
redis_master = sentinel.master_for(
    'mymaster',
    socket_timeout=0.5,
    decode_responses=True
)

# è·å–ä»èŠ‚ç‚¹è¿æ¥ï¼ˆç”¨äºè¯»æ“ä½œï¼‰
redis_slave = sentinel.slave_for(
    'mymaster',
    socket_timeout=0.5,
    decode_responses=True
)
```

**4. ç›‘æ§ä¸å‘Šè­¦**

```python
def monitor_lock_metrics():
    """ç›‘æ§ Redis é”çš„å…³é”®æŒ‡æ ‡"""
    metrics = {
        # å½“å‰æ´»è·ƒé”æ•°é‡
        'active_locks': len(redis_client.keys("ticket:lock:*")),

        # å¹³å‡é”æŒæœ‰æ—¶é—´
        'avg_lock_ttl': calculate_avg_ttl("ticket:lock:*"),

        # Redis å†…å­˜ä½¿ç”¨
        'redis_memory_used': redis_client.info('memory')['used_memory_human'],

        # é”äº‰ç”¨ç‡
        'lock_contention_rate': get_lock_contention_rate()
    }

    # å‘Šè­¦é˜ˆå€¼
    if metrics['active_locks'] > 10000:
        alert("High number of active locks")

    return metrics

def calculate_avg_ttl(pattern):
    """è®¡ç®—åŒ¹é…æ¨¡å¼çš„ key çš„å¹³å‡ TTL"""
    keys = redis_client.keys(pattern)
    if not keys:
        return 0

    pipe = redis_client.pipeline()
    for key in keys:
        pipe.ttl(key)
    ttls = pipe.execute()

    valid_ttls = [t for t in ttls if t > 0]
    return sum(valid_ttls) / len(valid_ttls) if valid_ttls else 0
```

#### âœ… ä¼˜åŠ¿

| ä¼˜åŠ¿               | è¯´æ˜                                        |
| ------------------ | ------------------------------------------- |
| **æé«˜æ€§èƒ½**       | Redis å†…å­˜æ“ä½œï¼ŒQPS å¯è¾¾æ•°ä¸‡                |
| **è‡ªåŠ¨è¿‡æœŸ**       | åˆ©ç”¨ Redis TTLï¼Œæ— éœ€å®šæ—¶ä»»åŠ¡                |
| **å‡å°‘æ•°æ®åº“å‹åŠ›** | é«˜é¢‘æŸ¥è¯¢åœ¨ Redis å®Œæˆï¼Œæ•°æ®åº“åªå¤„ç†æœ€ç»ˆçŠ¶æ€ |
| **æ°´å¹³æ‰©å±•**       | Redis é›†ç¾¤å¯è½»æ¾æ‰©å±•                        |
| **åŸå­æ“ä½œ**       | SET NX EX ä¿è¯åŸå­æ€§ï¼Œé¿å…ç«æ€æ¡ä»¶          |
| **ç®€å•å¯é **       | å®ç°ç®€å•ï¼Œæ•…éšœæ¢å¤å¿«                        |

#### âš ï¸ æ³¨æ„äº‹é¡¹

| æ³¨æ„ç‚¹           | è¯´æ˜                             | è§£å†³æ–¹æ¡ˆ                        |
| ---------------- | -------------------------------- | ------------------------------- |
| **Redis æ•…éšœ**   | Redis å®•æœºå¯¼è‡´é”ä¿¡æ¯ä¸¢å¤±         | ä½¿ç”¨ Redis Sentinel/Cluster     |
| **æ•°æ®ä¸€è‡´æ€§**   | Redis å’Œæ•°æ®åº“çŠ¶æ€å¯èƒ½çŸ­æš‚ä¸ä¸€è‡´ | ä»¥æ•°æ®åº“ä¸ºå‡†ï¼ŒRedis ä½œä¸ºç¼“å­˜å±‚  |
| **æ—¶é’ŸåŒæ­¥**     | TTL ä¾èµ–æœåŠ¡å™¨æ—¶é’Ÿ               | ä½¿ç”¨ NTP åŒæ­¥æœåŠ¡å™¨æ—¶é—´         |
| **å†…å­˜ä½¿ç”¨**     | å¤§é‡é”å ç”¨ Redis å†…å­˜            | ç›‘æ§å†…å­˜ï¼Œè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´    |
| **é”é‡Šæ”¾å®‰å…¨æ€§** | é˜²æ­¢è¯¯åˆ å…¶ä»–ç”¨æˆ·çš„é”             | ä½¿ç”¨ Lua è„šæœ¬éªŒè¯æ‰€æœ‰æƒåå†åˆ é™¤ |

#### æ€§èƒ½æµ‹è¯•æ•°æ®

**æµ‹è¯•åœºæ™¯**ï¼š10000 äººæŠ¢ 100 å¼ ç¥¨

```
å‹æµ‹ç»“æœï¼š
- æŸ¥è¯¢ TPS: ~8000ï¼ˆRedis æŸ¥è¯¢ï¼‰
- é”å®š TPS: ~2000ï¼ˆåŒ…å«æ•°æ®åº“éªŒè¯ï¼‰
- å¹³å‡å“åº”æ—¶é—´: 15ms
- P95 å»¶è¿Ÿ: 30ms
- P99 å»¶è¿Ÿ: 50ms
- Redis CPU ä½¿ç”¨ç‡: 30%
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡: 40%

å¯¹æ¯”æ–¹æ¡ˆä¸‰ï¼ˆçº¯æ•°æ®åº“ï¼‰ï¼š
- TPS æå‡: 2å€
- å“åº”æ—¶é—´é™ä½: 70%
- æ•°æ®åº“å‹åŠ›é™ä½: 80%
```

#### ä¸æ–¹æ¡ˆä¸‰çš„å¯¹æ¯”

| æ–¹é¢           | æ–¹æ¡ˆä¸‰ï¼ˆçº¯æ•°æ®åº“ï¼‰         | æ–¹æ¡ˆå››ï¼ˆRedis é”ï¼‰        |
| -------------- | -------------------------- | ------------------------- |
| **æŸ¥è¯¢æ€§èƒ½**   | ğŸŸ¡ ä¸­ï¼ˆæ•°æ®åº“æŸ¥è¯¢ï¼‰        | âœ… æé«˜ï¼ˆå†…å­˜æŸ¥è¯¢ï¼‰       |
| **å†™å…¥æ€§èƒ½**   | âœ… é«˜                      | âœ… é«˜                     |
| **æ•°æ®åº“å‹åŠ›** | ğŸŸ¡ ä¸­ï¼ˆæ¯æ¬¡æŸ¥è¯¢éƒ½è®¿é—® DBï¼‰ | âœ… ä½ï¼ˆåªåœ¨å…³é”®æ“ä½œè®¿é—®ï¼‰ |
| **è¿‡æœŸå³æ—¶æ€§** | âœ… å³æ—¶ï¼ˆæŸ¥è¯¢æ—¶åˆ¤æ–­ï¼‰      | âœ… å³æ—¶ï¼ˆRedis TTLï¼‰      |
| **ä¸€è‡´æ€§**     | âœ… å¼ºä¸€è‡´ï¼ˆäº‹åŠ¡ä¿è¯ï¼‰      | ğŸŸ¡ æœ€ç»ˆä¸€è‡´ï¼ˆæ•°æ®åº“ä¸ºå‡†ï¼‰ |
| **å®ç°å¤æ‚åº¦** | âœ… ä½ï¼ˆçº¯ SQLï¼‰            | ğŸŸ¡ ä¸­ï¼ˆRedis + æ•°æ®åº“ï¼‰   |
| **ä¾èµ–ç»„ä»¶**   | âœ… åªä¾èµ–æ•°æ®åº“            | ğŸŸ¡ ä¾èµ– Redis + æ•°æ®åº“    |
| **æ‰©å±•æ€§**     | ğŸŸ¡ å—é™äºæ•°æ®åº“æ€§èƒ½        | âœ… Redis é›†ç¾¤æ˜“æ‰©å±•       |
| **é€‚ç”¨åœºæ™¯**   | ä¸­ç­‰å¹¶å‘ï¼ˆ< 1000 QPSï¼‰     | é«˜å¹¶å‘ï¼ˆ> 5000 QPSï¼‰      |

#### æ··åˆæ–¹æ¡ˆï¼ˆæœ€ä½³å®è·µï¼‰

åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯ä»¥ç»“åˆæ–¹æ¡ˆä¸‰å’Œæ–¹æ¡ˆå››ï¼š

```python
def reserve_ticket_hybrid(ticket_id, user_id, hold_minutes=10):
    """
    æ··åˆæ–¹æ¡ˆï¼šRedis é” + æ•°æ®åº“åŒé‡éªŒè¯

    ä¼˜åŠ¿ï¼š
    1. Redis å¤„ç†é«˜é¢‘æŸ¥è¯¢ï¼Œå‡è½»æ•°æ®åº“å‹åŠ›
    2. æ•°æ®åº“ä½œä¸ºæœ€ç»ˆçœŸç›¸æºï¼Œä¿è¯å¼ºä¸€è‡´æ€§
    3. å³ä½¿ Redis æ•…éšœï¼Œç³»ç»Ÿä»å¯é™çº§åˆ°çº¯æ•°æ®åº“æ¨¡å¼
    """
    lock_key = f"ticket:lock:{ticket_id}"

    # å¿«é€Ÿè·¯å¾„ï¼šRedis é”æ£€æŸ¥
    if redis_client.exists(lock_key):
        holder = redis_client.get(lock_key)
        if holder != str(user_id):
            return {'success': False, 'error': 'TICKET_LOCKED'}

    # æ…¢é€Ÿè·¯å¾„ï¼šæ•°æ®åº“éªŒè¯ + Redis é”å®š
    try:
        with db.transaction() as tx:
            # æ•°æ®åº“éªŒè¯ï¼ˆæ–¹æ¡ˆä¸‰ï¼‰
            ticket = tx.execute("""
                SELECT * FROM tickets
                WHERE ticket_id = %s
                AND (
                    status = 'AVAILABLE'
                    OR (status = 'RESERVED' AND expires_at < CURRENT_TIMESTAMP)
                )
                FOR UPDATE
            """, [ticket_id])

            if not ticket:
                return {'success': False, 'error': 'TICKET_NOT_AVAILABLE'}

            # æ›´æ–°æ•°æ®åº“çŠ¶æ€
            tx.execute("""
                UPDATE tickets
                SET status = 'RESERVED',
                    reserved_by = %s,
                    reserved_at = CURRENT_TIMESTAMP,
                    expires_at = CURRENT_TIMESTAMP + INTERVAL '%s minutes'
                WHERE ticket_id = %s
            """, [user_id, hold_minutes, ticket_id])

            # è®¾ç½® Redis é”
            redis_client.set(
                lock_key,
                user_id,
                ex=hold_minutes * 60
            )

            tx.commit()

            return {
                'success': True,
                'ticket_id': ticket_id,
                'expires_in': hold_minutes * 60
            }

    except Exception as e:
        logger.error(f"Reserve failed: {e}")
        # æ¸…ç†å¯èƒ½åˆ›å»ºçš„ Redis é”
        redis_client.delete(lock_key)
        return {'success': False, 'error': 'SYSTEM_ERROR'}
```

#### é™çº§ç­–ç•¥

```python
class TicketReservationService:
    def __init__(self):
        self.redis_available = True
        self.check_redis_health()

    def check_redis_health(self):
        """æ£€æŸ¥ Redis å¥åº·çŠ¶æ€"""
        try:
            self.redis_available = redis_client.ping()
        except:
            self.redis_available = False

    def reserve_ticket(self, ticket_id, user_id, hold_minutes=10):
        """æ™ºèƒ½é™çº§çš„é¢„ç•™æ–¹æ³•"""
        if self.redis_available:
            try:
                # å°è¯•ä½¿ç”¨ Redis æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆå››ï¼‰
                return self._reserve_with_redis(ticket_id, user_id, hold_minutes)
            except RedisError:
                logger.warning("Redis unavailable, falling back to database-only mode")
                self.redis_available = False

        # é™çº§åˆ°çº¯æ•°æ®åº“æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆä¸‰ï¼‰
        return self._reserve_database_only(ticket_id, user_id, hold_minutes)
```

---

## æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

### åŠŸèƒ½å¯¹æ¯”

| ç»´åº¦           | æ–¹æ¡ˆä¸€ï¼šé•¿æ—¶é—´é” | æ–¹æ¡ˆäºŒï¼šå®šæ—¶ä»»åŠ¡ | æ–¹æ¡ˆä¸‰ï¼šåŒå±æ€§æ£€æŸ¥ | æ–¹æ¡ˆå››ï¼šRedis é” |
| -------------- | ---------------- | ---------------- | ------------------ | ---------------- |
| **å¹¶å‘æ€§èƒ½**   | âŒ å·®            | ğŸŸ¡ ä¸­            | âœ… ä¼˜              | âœ… æä¼˜          |
| **èµ„æºå ç”¨**   | âŒ é«˜            | ğŸŸ¡ ä¸­            | âœ… ä½              | âœ… ä½            |
| **è¿‡æœŸå³æ—¶æ€§** | ğŸŸ¡ ä¾èµ–è¶…æ—¶      | âŒ æœ‰å»¶è¿Ÿ        | âœ… å³æ—¶            | âœ… å³æ—¶          |
| **å¯é æ€§**     | âŒ é£é™©é«˜        | ğŸŸ¡ ä¾èµ–ä»»åŠ¡      | âœ… é«˜              | ğŸŸ¡ ä¾èµ– Redis    |
| **æ‰©å±•æ€§**     | âŒ éš¾æ‰©å±•        | ğŸŸ¡ ä¸­            | âœ… æ˜“æ‰©å±•          | âœ… ææ˜“æ‰©å±•      |
| **å®ç°å¤æ‚åº¦** | ğŸŸ¡ ä¸­            | ğŸŸ¡ ä¸­            | âœ… ä½              | ğŸŸ¡ ä¸­            |
| **æ­»é”é£é™©**   | âŒ é«˜            | âœ… æ—             | âœ… æ—               | âœ… æ—             |
| **æ•°æ®ä¸€è‡´æ€§** | âœ… å¼º            | ğŸŸ¡ æœ€ç»ˆä¸€è‡´      | âœ… å¼º              | ğŸŸ¡ æœ€ç»ˆä¸€è‡´      |
| **æ•°æ®åº“å‹åŠ›** | âŒ æé«˜          | ğŸŸ¡ ä¸­            | ğŸŸ¡ ä¸­              | âœ… ä½            |
| **æŸ¥è¯¢æ€§èƒ½**   | âŒ æ…¢            | ğŸŸ¡ ä¸­            | ğŸŸ¡ ä¸­              | âœ… æå¿«          |

### æ€§èƒ½æµ‹è¯•å¯¹æ¯”

å‡è®¾åœºæ™¯ï¼š10000 äººæŠ¢ 100 å¼ ç¥¨

```
æ–¹æ¡ˆä¸€ï¼ˆé•¿æ—¶é—´é”ï¼‰ï¼š
- TPS: ~50
- å¹³å‡å“åº”æ—¶é—´: 2000ms
- 99åˆ†ä½å»¶è¿Ÿ: 10000ms
- æ­»é”ç‡: 2%

æ–¹æ¡ˆäºŒï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰ï¼š
- TPS: ~500
- å¹³å‡å“åº”æ—¶é—´: 200ms
- 99åˆ†ä½å»¶è¿Ÿ: 1000ms
- è¿‡æœŸå»¶è¿Ÿ: 0-60ç§’

æ–¹æ¡ˆä¸‰ï¼ˆåŒå±æ€§æ£€æŸ¥ï¼‰ï¼š
- TPS: ~1000
- å¹³å‡å“åº”æ—¶é—´: 50ms
- 99åˆ†ä½å»¶è¿Ÿ: 200ms
- è¿‡æœŸå»¶è¿Ÿ: 0ç§’

æ–¹æ¡ˆå››ï¼ˆRedis é”ï¼‰ï¼š
- TPS: ~2000
- å¹³å‡å“åº”æ—¶é—´: 15ms
- 99åˆ†ä½å»¶è¿Ÿ: 50ms
- è¿‡æœŸå»¶è¿Ÿ: 0ç§’
- Redis QPS: ~8000
```

### é€‚ç”¨åœºæ™¯

| æ–¹æ¡ˆ       | æ¨èåœºæ™¯                            | ä¸æ¨èåœºæ™¯              |
| ---------- | ----------------------------------- | ----------------------- |
| **æ–¹æ¡ˆä¸€** | âš ï¸ å‡ ä¹ä¸æ¨è                       | æ‰€æœ‰ç”Ÿäº§ç¯å¢ƒ            |
| **æ–¹æ¡ˆäºŒ** | ä½å¹¶å‘ã€å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜            | ç§’æ€ã€çƒ­é—¨æ´»åŠ¨          |
| **æ–¹æ¡ˆä¸‰** | âœ… ä¸­é«˜å¹¶å‘ã€å®æ—¶æ€§è¦æ±‚é«˜           | è¶…é«˜å¹¶å‘ï¼ˆ>5000 QPSï¼‰   |
| **æ–¹æ¡ˆå››** | âœ… è¶…é«˜å¹¶å‘ã€æè‡´æ€§èƒ½è¦æ±‚ã€æœ‰ Redis | æ—  Redis æˆ–è¦æ±‚å¼ºä¸€è‡´æ€§ |

---

## æœ€ä½³å®è·µå»ºè®®

### 1. æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·ç«¯    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APIç½‘å…³    â”‚ â† é™æµã€ç†”æ–­
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢ç¥¨æœåŠ¡é›†ç¾¤ â”‚ â† æ— çŠ¶æ€ã€å¯æ°´å¹³æ‰©å±•
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redisç¼“å­˜ â”‚   â”‚ æ•°æ®åº“é›†ç¾¤â”‚ â† è¯»å†™åˆ†ç¦»
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å…³é”®å‚æ•°é…ç½®

```python
# é…ç½®å»ºè®®
CONFIG = {
    # é¢„ç•™æ—¶é•¿
    'RESERVATION_MINUTES': 10,  # æ™®é€šå•†å“
    'RESERVATION_MINUTES_HOTSPOT': 5,  # çƒ­é—¨å•†å“

    # è¶…æ—¶é…ç½®
    'DB_QUERY_TIMEOUT': 3000,  # 3ç§’
    'DB_TRANSACTION_TIMEOUT': 5000,  # 5ç§’

    # å¹¶å‘æ§åˆ¶
    'MAX_CONCURRENT_RESERVATIONS_PER_USER': 3,
    'RATE_LIMIT_PER_MINUTE': 60,

    # ç¼“å­˜
    'CACHE_TTL_SECONDS': 5,
    'CACHE_HOTSPOT_TTL_SECONDS': 2,
}
```

### 3. ç›‘æ§æŒ‡æ ‡

```python
# å…³é”®æŒ‡æ ‡
metrics = {
    'reservation_success_rate': 0.95,  # é¢„ç•™æˆåŠŸç‡
    'reservation_avg_latency_ms': 50,  # å¹³å‡å»¶è¿Ÿ
    'reservation_p99_latency_ms': 200,  # 99åˆ†ä½å»¶è¿Ÿ
    'conversion_rate': 0.7,  # é¢„ç•™åˆ°è´­ä¹°è½¬åŒ–ç‡
    'expired_reservation_rate': 0.3,  # è¿‡æœŸç‡
    'concurrent_reservations': 1000,  # å¹¶å‘é¢„ç•™æ•°
}
```

### 4. å®¹é”™å¤„ç†

```python
def reserve_ticket_with_retry(ticket_id, user_id, max_retries=3):
    """å¸¦é‡è¯•çš„é¢„ç•™æ“ä½œ"""
    for attempt in range(max_retries):
        try:
            result = reserve_ticket(ticket_id, user_id)

            if result['success']:
                return result

            if result['error'] == 'TICKET_NOT_AVAILABLE':
                # ç¥¨å·²å”®å‡ºï¼Œä¸é‡è¯•
                return result

            # å…¶ä»–é”™è¯¯ï¼Œé‡è¯•
            time.sleep(0.1 * (2 ** attempt))  # æŒ‡æ•°é€€é¿

        except TimeoutError:
            logger.warning(f"Attempt {attempt + 1} timeout")
            continue
        except Exception as e:
            logger.error(f"Unexpected error: {e}")
            break

    return {'success': False, 'error': 'MAX_RETRIES_EXCEEDED'}
```

### 5. é˜²åˆ·æœºåˆ¶

```python
def check_rate_limit(user_id):
    """æ£€æŸ¥ç”¨æˆ·æ“ä½œé¢‘ç‡"""
    key = f"rate_limit:user:{user_id}"
    current = cache.incr(key)

    if current == 1:
        cache.expire(key, 60)  # 1åˆ†é’Ÿçª—å£

    if current > CONFIG['RATE_LIMIT_PER_MINUTE']:
        raise RateLimitExceeded(f"Too many requests from user {user_id}")

    return True

def check_concurrent_limit(user_id):
    """æ£€æŸ¥ç”¨æˆ·å¹¶å‘é¢„ç•™æ•°"""
    count = db.scalar("""
        SELECT COUNT(*) FROM tickets
        WHERE reserved_by = %s
        AND status = 'RESERVED'
        AND expires_at > CURRENT_TIMESTAMP
    """, [user_id])

    if count >= CONFIG['MAX_CONCURRENT_RESERVATIONS_PER_USER']:
        raise ConcurrentLimitExceeded(
            f"User {user_id} has {count} active reservations"
        )

    return True
```

### 6. å¹‚ç­‰æ€§ä¿è¯

```python
def reserve_ticket_idempotent(ticket_id, user_id, idempotency_key):
    """å¹‚ç­‰çš„é¢„ç•™æ“ä½œ"""
    # æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
    cached_result = cache.get(f"reservation:{idempotency_key}")
    if cached_result:
        return json.loads(cached_result)

    # æ‰§è¡Œé¢„ç•™
    result = reserve_ticket(ticket_id, user_id)

    # ç¼“å­˜ç»“æœï¼ˆ15åˆ†é’Ÿï¼‰
    cache.setex(
        f"reservation:{idempotency_key}",
        900,
        json.dumps(result)
    )

    return result
```

### 7. é™çº§ç­–ç•¥

```python
# ç³»ç»Ÿé™çº§ç­–ç•¥
DEGRADATION_LEVELS = {
    'NORMAL': {
        'reservation_enabled': True,
        'cache_enabled': True,
        'analytics_enabled': True,
    },
    'DEGRADED': {
        'reservation_enabled': True,
        'cache_enabled': True,
        'analytics_enabled': False,  # å…³é—­éå…³é”®åŠŸèƒ½
    },
    'CRITICAL': {
        'reservation_enabled': False,  # åˆ‡æ¢åˆ°æ’é˜Ÿæ¨¡å¼
        'cache_enabled': True,
        'analytics_enabled': False,
    }
}
```

---

## æ‰©å±•é˜…è¯»

### ç›¸å…³ç³»ç»Ÿè®¾è®¡

- **åˆ†å¸ƒå¼é”**ï¼šRedis SETNX/Redlockã€Zookeeperã€etcd
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå‰Šå³°å¡«è°·ã€å¼‚æ­¥å¤„ç†
- **é™æµç®—æ³•**ï¼šä»¤ç‰Œæ¡¶ã€æ¼æ¡¶ã€æ»‘åŠ¨çª—å£
- **ç¼“å­˜ç­–ç•¥**ï¼šå¤šçº§ç¼“å­˜ã€ç¼“å­˜ç©¿é€/å‡»ç©¿/é›ªå´©é˜²æŠ¤
- **æ•°æ®åº“ä¼˜åŒ–**ï¼šåˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»ã€è¿æ¥æ± ç®¡ç†
- **é«˜å¯ç”¨æ¶æ„**ï¼šRedis Sentinel/Clusterã€æ•°æ®åº“ä¸»ä»å¤åˆ¶

### å®æˆ˜æ¡ˆä¾‹

- **12306 æŠ¢ç¥¨**ï¼šå€™è¡¥è®¢å•æœºåˆ¶
- **æ·˜å®åŒ 11**ï¼šé¢„å”® + åˆ†å±‚åº“å­˜
- **æ¼”å”±ä¼šé—¨ç¥¨**ï¼šè™šæ‹Ÿé˜Ÿåˆ— + é¢„ç•™æœºåˆ¶

---

## æ€»ç»“

åœ¨è®¢ç¥¨/ç§’æ€ç³»ç»Ÿä¸­ï¼Œæ¨èçš„æœ€ä½³å®è·µæ–¹æ¡ˆï¼š

### ğŸ¥‡ æ–¹æ¡ˆé€‰æ‹©å»ºè®®

**ä¸­ç­‰å¹¶å‘åœºæ™¯ï¼ˆ< 1000 QPSï¼‰**

- âœ… **æ–¹æ¡ˆä¸‰ï¼ˆåŒå±æ€§æ£€æŸ¥ + çŸ­äº‹åŠ¡ï¼‰**
- ä¼˜åŠ¿ï¼šå®ç°ç®€å•ã€å¼ºä¸€è‡´æ€§ã€æ— é¢å¤–ä¾èµ–
- é€‚ç”¨ï¼šæ¼”å”±ä¼šè®¢ç¥¨ã€æ´»åŠ¨æŠ¥åã€æ™®é€šç§’æ€

**é«˜å¹¶å‘åœºæ™¯ï¼ˆ> 5000 QPSï¼‰**

- âœ… **æ–¹æ¡ˆå››ï¼ˆRedis åˆ†å¸ƒå¼é”ï¼‰æˆ– æ··åˆæ–¹æ¡ˆ**
- ä¼˜åŠ¿ï¼šæè‡´æ€§èƒ½ã€å‡è½»æ•°æ®åº“å‹åŠ›ã€æ˜“æ‰©å±•
- é€‚ç”¨ï¼šçƒ­é—¨æ¼”å”±ä¼šã€é™é‡å•†å“ã€å¤§å‹ä¿ƒé”€æ´»åŠ¨

### âœ… **æ ¸å¿ƒä¼˜åŠ¿**

**æ–¹æ¡ˆä¸‰ä¼˜åŠ¿ï¼š**

- å³æ—¶è¿‡æœŸï¼Œæ— å»¶è¿Ÿ
- çŸ­äº‹åŠ¡ï¼Œé«˜æ€§èƒ½
- æ— é¢å¤–ä¾èµ–ï¼Œæ˜“ç»´æŠ¤

**æ–¹æ¡ˆå››ä¼˜åŠ¿ï¼š**

- æé«˜æ€§èƒ½ï¼ˆTPS 2 å€æå‡ï¼‰
- æ•°æ®åº“å‹åŠ›é™ä½ 80%
- æ°´å¹³æ‰©å±•èƒ½åŠ›å¼º

### ğŸ¯ **å®æ–½è¦ç‚¹**

- æ­£ç¡®çš„æ•°æ®åº“ç´¢å¼•è®¾è®¡
- åˆç†çš„ Redis é…ç½®ï¼ˆSentinel/Clusterï¼‰
- å®Œå–„çš„ç›‘æ§å‘Šè­¦ä½“ç³»
- å¤šå±‚æ¬¡çš„é™æµé˜²æŠ¤
- ä¼˜é›…çš„é™çº§ç­–ç•¥

### ğŸ’¡ **è®¾è®¡åŸåˆ™**

1. **ç®€å•ä¼˜äºå¤æ‚**ï¼šæ ¹æ®å®é™… QPS é€‰æ‹©åˆé€‚æ–¹æ¡ˆ
2. **æ€§èƒ½ä¸ä¸€è‡´æ€§å…¼é¡¾**ï¼šæ··åˆæ–¹æ¡ˆç»“åˆä¸¤è€…ä¼˜åŠ¿
3. **å…³æ³¨æç«¯æƒ…å†µ**ï¼šRedis æ•…éšœé™çº§ã€ç½‘ç»œå»¶è¿Ÿ
4. **æŒç»­ä¼˜åŒ–è¿­ä»£**ï¼šç›‘æ§æŒ‡æ ‡é©±åŠ¨ä¼˜åŒ–å†³ç­–

### ğŸ”„ **æ¼”è¿›è·¯å¾„**

```
åˆ›ä¸šåˆæœŸ â”€â”€> ä¸šåŠ¡å¢é•¿ â”€â”€> æµé‡çˆ†å‘
    â”‚            â”‚            â”‚
    â–¼            â–¼            â–¼
 æ–¹æ¡ˆä¸‰      æ–¹æ¡ˆä¸‰+ç¼“å­˜    æ–¹æ¡ˆå››/æ··åˆ
(çº¯æ•°æ®åº“)   (é€æ­¥ä¼˜åŒ–)   (Redisé”)
```
