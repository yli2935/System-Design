<!--
 * @Author: Li yli2935@uwo.ca
 * @Date: 2026-01-10 17:17:49
 * @LastEditors: Li
 * @LastEditTime: 2026-01-10 17:36:19
 * @FilePath: /System-Design/core/Networking.md
-->

# Networking 网络基础

## 网络基础介绍

在系统设计中，理解网络的基本原理至关重要。网络通信遵循分层模型，每一层都有其特定的职责和协议。本文档主要关注最核心的三层：**应用层**、**传输层**和**网络层**。

### 为什么要分层？

分层架构带来了以下优势：

- **关注点分离**：每层专注于解决特定问题
- **模块化**：层与层之间通过明确的接口交互
- **灵活性**：可以独立更换某一层的实现而不影响其他层
- **易于理解**：将复杂的网络通信分解为可管理的部分

### 七层模型概览

![OSI Model](assets/Networking/OSI.png)

#### 应用层 (Application Layer)

**职责**：为应用程序提供网络服务接口

- **数据单位**：消息 (Message)
- **关键协议**：HTTP/HTTPS, DNS, WebSocket, gRPC, FTP, SMTP
- **关注点**：业务逻辑、数据格式、用户交互

#### 传输层 (Transport Layer)

**职责**：提供端到端的数据传输服务

- **数据单位**：段 (Segment)
- **关键协议**：TCP, UDP
- **关注点**：可靠性、流量控制、拥塞控制、端口管理

#### 网络层 (Network Layer)

**职责**：在网络中进行路由选择和寻址

- **数据单位**：数据包 (Packet)
- **关键协议**：IP, ICMP, ARP
- **关注点**：IP 地址、路由、跨网络通信

---

## 详细知识点

### 1. 网络层 (Network Layer)

网络层负责在不同网络之间传输数据包，实现主机到主机的通信。对于系统设计来说，理解 IP 地址、NAT 和基本的路由概念即可。

#### 1.1 IP 地址：公网 vs 私有

**公网 IP 地址 (Public IP)**

- 全球唯一，可以在互联网上直接访问
- 由 ISP（互联网服务提供商）分配
- 数量有限，需要付费获取
- 例如：`8.8.8.8`（Google DNS）

**私有 IP 地址 (Private IP)**

- 仅在局域网内使用，不能在公网上路由
- 可以在不同的私有网络中重复使用
- 免费使用，无需申请
- 三个保留范围（RFC 1918）：
  - `10.0.0.0/8` - 适用于大型企业网络
  - `172.16.0.0/12` - 适用于中型企业网络
  - `192.168.0.0/16` - 适用于家庭/小型办公网络

**为什么需要私有 IP？**

- IPv4 地址只有约 43 亿个，无法满足全球设备需求
- 私有 IP 可以重复使用，节约地址资源
- 通过 NAT 技术让私有网络访问公网

#### 1.2 NAT (Network Address Translation)

NAT 允许多个私有 IP 设备共享一个公网 IP 访问互联网，是解决 IPv4 地址短缺的关键技术。

**工作原理**

```
家庭/企业内网（私有IP）          路由器（NAT）         互联网（公网IP）
┌─────────────────────┐           ┌──────┐           ┌──────────┐
│ 电脑: 192.168.1.10  │           │      │           │          │
│ 手机: 192.168.1.11  │  ────→    │ NAT  │  ────→    │  服务器  │
│ 平板: 192.168.1.12  │           │      │           │          │
└─────────────────────┘           └──────┘           └──────────┘
    多个私有IP地址              203.0.113.5           8.8.8.8
                            单个公网IP + 不同端口
```

路由器通过 **IP + 端口号** 的组合来区分不同的内网设备（也称为 PAT - Port Address Translation）。

**对系统设计的影响**

✅ **优点**

- 节约公网 IP 地址，降低成本
- 内网设备不直接暴露，提高安全性
- 企业可以自由规划内网地址

❌ **缺点和挑战**

- **P2P 连接困难**：两个都在 NAT 后的设备无法直接通信
  - 解决方案：NAT 穿透技术（STUN、TURN、ICE）
- **服务器部署问题**：NAT 后的机器无法直接提供公网服务
  - 解决方案：端口转发、使用云服务器
- **WebSocket/长连接**：需要保持 NAT 映射，可能超时断开
  - 解决方案：定期发送心跳包

**系统设计中的实际应用**

- 视频会议（WebRTC）需要 STUN/TURN 服务器处理 NAT 穿透
- 游戏服务器通常部署在有公网 IP 的环境
- 企业内网应用通过 VPN 或反向代理暴露服务

#### 1.3 网络层关键概念

**IPv4 vs IPv6**

- **IPv4**：32 位地址，地址空间有限（43 亿个）
- **IPv6**：128 位地址，解决地址短缺，但普及较慢
- 系统设计时需要考虑双栈支持（同时支持 IPv4 和 IPv6）
